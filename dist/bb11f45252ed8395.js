const COLS=10,ROWS=17;let MATRIX=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[-9,-9,-9,-9,-9,-9,-9,-9,-9,-9]],MATRIX2=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[-9,-9,-9,-9,-9,-9,-9,-9,-9,-9]];const L=[[0,0,0,1],[0,1,1,1]],J=[[2,0,0,0],[2,2,2,0]],S=[[0,0,3,3],[0,3,3,0]],Z=[[4,4,0,0],[0,4,4,0]],O=[[0,5,5,0],[0,5,5,0]],T=[[0,6,6,6],[0,0,6,0]],I=[[7,7,7,7],[0,0,0,0]],TETRIMINOS=[L,J,S,Z,O,T,I];let pauseAll=!0;const play=document.getElementById("play"),playFunc=()=>{!pauseAll||gameEnded||gameEnded2||(document.getElementById("play").style.display="none",document.getElementById("restart").style.display="flex",pauseAll=!1,animatePage(),placeOnMatrix(),placeOnMatrix2(),levelTimer=setInterval(levelFunc,1e3),dropLoop=setInterval(dropInterval,rate[rateIndex]),dropLoop2=setInterval(dropInterval2,rate[rateIndex]),timeStart=performance.now())};play.addEventListener("click",playFunc);const pauseFunc=()=>{pauseAll?(pauseAll=!1,animatePage(),document.getElementById("pause-btn").style.color="var(--color-piece0)"):pauseAll||(pauseAll=!0,cancelAnimationFrame(animateInterval),document.getElementById("pause-btn").style.color="var(--color-piece4)")},pause=document.getElementById("pause-btn");pause.addEventListener("click",pauseFunc);const restartFunc=()=>{document.getElementById("restart").style.display="none",document.getElementById("play").style.display="flex",restart()},restartBtn=document.getElementById("restart");restartBtn.addEventListener("click",restartFunc);const restart=()=>{pauseAll=!0,paused=!1,clearInterval(dropLoop2),clearInterval(dropLoop),clearInterval(levelTimer),level=1,timer=60,points1=0,points2=0,document.getElementById("points1").innerHTML=points1,document.getElementById("points2").innerHTML=points2,document.getElementById("level").innerHTML=level,document.getElementById("time").innerHTML=timer,MATRIX=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[-9,-9,-9,-9,-9,-9,-9,-9,-9,-9]],gameEnded=!1,rateIndex=0,activeTetrimino=[],MATRIX2=[[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[-9,-9,-9,-9,-9,-9,-9,-9,-9,-9]],gameEnded2=!1,activeTetrimino2=[],cancelAnimationFrame(animateInterval),animateInterval=null,updateColor(),updateColor2()};let timer=60,level=1;const rate=[1e3,900,800,700,600,500,400,300,200,100];let levelTimer,dropLoop,dropLoop2,animateInterval,rateIndex=0,timeStart=null,timeLapsed=null,drop1st=!1;const animatePage=()=>{pauseAll||(null===timeStart&&(timeStart=performance.now()),timeLapsed=performance.now(),timeLapsed-timeStart>59&&(drop1st||(executeDrop(),drop1st=!0)),timeLapsed-timeStart>120&&(executeMoves(),timeStart=performance.now(),drop1st=!1),gameEnded2||updateColor2(),gameEnded||updateColor(),animateInterval=requestAnimationFrame(animatePage))},levelFunc=()=>{pauseAll||(document.getElementById("time").innerHTML=timer,timer--,0===timer&&(rateIndex++,document.getElementById("time").innerHTML="New Level",timer=60,level++,document.getElementById("level").innerHTML=level,changeLevel()))},dropInterval=()=>{!1!==moves[40].pressed||pauseAll||paused||(stopTest(),lowerTetrimino())};let dropInterval2=()=>{!1!==moves[83].pressed||pauseAll||paused2||(stopTest2(),lowerTetrimino2())};const changeLevel=()=>{level<9&&(currentAttackGoing||(clearInterval(dropLoop2),dropLoop2=setInterval(dropInterval2,rate[rateIndex]),currentAttackGoing2||clearInterval(dropLoop),dropLoop=setInterval(dropInterval,rate[rateIndex])))};let activeColor=null,tetrimino=null,activeColor2=null,tetrimino2=null,activeTetrimino=[],activeTetrimino2=[],stopped=!1,stopped2=!1,gameEnded=!1,gameEnded2=!1,paused=!1,paused2=!1;const sleep=e=>new Promise((t=>setTimeout(t,e)));async function placeOnMatrix(){paused=!0,currentSpin=0,tetrimino=TETRIMINOS[Math.floor(7*Math.random())];let e=tetrimino[0].filter((e=>e>0));activeColor=e[0],activeTetrimino=[];for(let e=3;e<6;e++)(MATRIX[0][e]<0||MATRIX[1][e]<0)&&(gameEnded=!0);if(await sleep(500),!gameEnded){for(let e=3;e<7;e++)tetrimino[0][e-3]>0&&(MATRIX[0][e]=activeColor,activeTetrimino.push([0,e]));for(let e=3;e<7;e++)tetrimino[1][e-3]>0&&(MATRIX[1][e]=activeColor,activeTetrimino.push([1,e]))}endGame(),paused=!1}async function placeOnMatrix2(){paused2=!0,currentSpin2=0,tetrimino2=TETRIMINOS[Math.floor(7*Math.random())];let e=tetrimino2[0].filter((e=>e>0));activeColor2=e[0],activeTetrimino2=[];for(let e=3;e<6;e++)(MATRIX2[0][e]<0||MATRIX2[1][e]<0)&&(gameEnded2=!0);if(await sleep(500),!gameEnded2){for(let e=3;e<7;e++)tetrimino2[0][e-3]>0&&(MATRIX2[0][e]=activeColor2,activeTetrimino2.push([0,e]));for(let e=3;e<7;e++)tetrimino2[1][e-3]>0&&(MATRIX2[1][e]=activeColor2,activeTetrimino2.push([1,e]))}endGame2(),paused2=!1}const lowerTetrimino=()=>{if(!stopped){for(let e=activeTetrimino.length-1;e>=0;e--)activeTetrimino[e][0]=activeTetrimino[e][0]+1;updateMatrix()}},updateMatrix=()=>{clearPrevious();for(let e=activeTetrimino.length-1;e>=0;e--){let t=activeTetrimino[e][0],r=activeTetrimino[e][1];MATRIX[t][r]=activeColor}},lowerTetrimino2=()=>{if(!stopped2){for(let e=activeTetrimino2.length-1;e>=0;e--)activeTetrimino2[e][0]=activeTetrimino2[e][0]+1;updateMatrix2()}},updateMatrix2=()=>{clearPrevious2();for(let e=activeTetrimino2.length-1;e>=0;e--){let t=activeTetrimino2[e][0],r=activeTetrimino2[e][1];MATRIX2[t][r]=activeColor2}},stopTest=()=>{for(let e=0;e<activeTetrimino.length;e++){let t=activeTetrimino[e][0]+1,r=activeTetrimino[e][1];MATRIX[t][r]<0&&(stopped=!0)}if(stopped){for(let e=0;e<activeTetrimino.length;e++){let t=activeTetrimino[e][0],r=activeTetrimino[e][1];MATRIX[t][r]=-activeColor}return isStopped(),!0}return!1},isStopped=()=>{rowCompletedTest(),placeOnMatrix(),stopped=!1},stopTest2=()=>{for(let e=0;e<activeTetrimino2.length;e++){let t=activeTetrimino2[e][0]+1,r=activeTetrimino2[e][1];MATRIX2[t][r]<0&&(stopped2=!0)}if(stopped2){for(let e=0;e<activeTetrimino2.length;e++){let t=activeTetrimino2[e][0],r=activeTetrimino2[e][1];MATRIX2[t][r]=-activeColor2}return isStopped2(),!0}return!1},isStopped2=()=>{stopped2&&(rowCompletedTest2(),placeOnMatrix2(),stopped2=!1)},endGame=()=>{gameEnded2&&gameEnded&&(pauseAll=!0,winUpdater())},endGame2=()=>{gameEnded2&&gameEnded&&(pauseAll=!0,winUpdater())},clearPrevious=()=>{for(let e=0;e<MATRIX.length-1;e++)for(let t=0;t<MATRIX[e].length;t++)MATRIX[e][t]>0&&(MATRIX[e][t]=0)},clearPrevious2=()=>{for(let e=0;e<MATRIX2.length-1;e++)for(let t=0;t<MATRIX2[e].length;t++)MATRIX2[e][t]>0&&(MATRIX2[e][t]=0)},updateColor=()=>{paused=!0;for(let e=0;e<MATRIX.length-1;e++)for(let t=0;t<MATRIX[e].length;t++)if(Math.abs(MATRIX[e][t])>0){let r=Math.abs(MATRIX[e][t]),n="_"+e+t;document.getElementById(n).style.backgroundColor=`var(--color-piece${r})`}else if(0===MATRIX[e][t]){let r="_"+e+t;document.getElementById(r).style.backgroundColor="var(--color-piece0)"}paused=!1},updateColor2=()=>{paused2=!0;for(let e=0;e<MATRIX2.length-1;e++)for(let t=0;t<MATRIX2[e].length;t++)if(Math.abs(MATRIX2[e][t])>0){let r=Math.abs(MATRIX2[e][t]),n="__"+e+t;document.getElementById(n).style.backgroundColor=`var(--color-piece${r})`}else if(0===MATRIX2[e][t]){let r="__"+e+t;document.getElementById(r).style.backgroundColor="var(--color-piece0)"}paused2=!1},rowCompletedTest=()=>{paused=!0;let e=0;for(let t=0;t<16;t++)MATRIX[t].every((e=>e<0))&&(MATRIX.splice(t,1),MATRIX.unshift(Array(10).fill(0)),e++);e>0&&points(e),paused=!1},rowCompletedTest2=()=>{paused2=!0;let e=0;for(let t=0;t<16;t++)MATRIX2[t].every((e=>e<0))&&(MATRIX2.splice(t,1),MATRIX2.unshift(Array(10).fill(0)),e++);e>0&&points2p(e),paused2=!1};let attacks=[],attacks2=[],canAttack=!0,canAttack2=!0,currentAttackGoing=!1,currentAttackGoing2=!1;const attack=()=>{if(void 0===attacks[0]||pauseAll)return;let e=canAttack;canAttack&&(canAttack=!1),e&&(2===attacks[0]?(clearInterval(dropLoop2),dropLoop2=setIntervaldropLoop2=setInterval(dropInterval2,rate[rateIndex]/4),setTimeout(resetAttack2,1e4)):1===attacks[0]&&(moves[65].func=right2,moves[68].func=left2,setTimeout(resetAttack1,1e4)),attacks.shift(),renderAttacks())},resetAttack1=()=>{moves[65].func=left2,moves[68].func=right2,canAttack=!0},resetAttack2=()=>{clearInterval(dropLoop2),dropLoop2=setInterval(dropInterval2,rate[rateIndex]),canAttack=!0},attack2=()=>{if(void 0===attacks2[0]||pauseAll)return;let e=canAttack2;canAttack2&&(canAttack2=!1),e&&(2===attacks2[0]?(clearInterval(dropLoop),dropLoop=setInterval(dropInterval,rate[rateIndex]/4),setTimeout(reset2Attack2,1e4)):1===attacks2[0]&&(moves[37].func=right,moves[39].func=left,setTimeout(reset2Attack1,1e4)),attacks2.shift(),renderAttacks())},reset2Attack1=()=>{moves[37].func=left,moves[39].func=right,canAttack2=!0},reset2Attack2=()=>{clearInterval(dropLoop),dropLoop=setInterval(dropInterval,rate[rateIndex]),canAttack2=!0},renderAttacks=()=>{const e=document.getElementById("attacks1");for(;e.firstChild;)e.removeChild(e.firstChild);for(let t=0;t<attacks.length;t++)if(2===attacks[t]){const t=document.createElement("img");t.src="./icons/cherryBomb2.png",e.appendChild(t)}else if(1===attacks[t]){const t=document.createElement("img");t.src="./icons/weakBomb2.png",e.appendChild(t)}const t=document.getElementById("attacks2");for(;t.firstChild;)t.removeChild(t.firstChild);for(let e=0;e<attacks2.length;e++)if(2===attacks2[e]){const e=document.createElement("img");e.src="./icons/cherryBomb2.png",t.appendChild(e)}else if(1===attacks2[e]){const e=document.createElement("img");e.src="./icons/weakBomb2.png",t.appendChild(e)}};let player1Wins=0,player2Wins=0,points1=0,points2=0;const pointsFor1Line=100,pointsPerLineSoftDrop=1,levelMultiplier=[0,1,1,2,2,3,3,4,4,5],lineMultiplier=[1,1,4,9,20];let perfectClearBonus=1;const points=e=>{0===MATRIX[15].filter((e=>e<0||e>0)).length&&(perfectClearBonus=10);let t=level;t>9&&(t=9),points1+=100*lineMultiplier[e]*levelMultiplier[t]*perfectClearBonus,document.getElementById("points1").innerHTML=points1,3===e&&(attacks.push(1),renderAttacks()),4===e&&(attacks.push(2),renderAttacks()),perfectClearBonus=1},points2p=e=>{0===MATRIX2[15].filter((e=>e<0||e>0)).length&&(perfectClearBonus=10);let t=level;t>9&&(t=9),points2+=100*lineMultiplier[e]*levelMultiplier[t]*perfectClearBonus,document.getElementById("points2").innerHTML=points2,3===e&&(attacks2.push(1),renderAttacks()),4===e&&(attacks2.push(2),renderAttacks()),perfectClearBonus=1},winUpdater=()=>{points1>points2?(player1Wins++,document.getElementById("player1-wins").innerHTML=player1Wins):points1<points2&&(player2Wins++,document.getElementById("player2-wins").innerHTML=player2Wins)},right=()=>{paused=!0;let e=!0;for(let t=0;t<activeTetrimino.length;t++){let r=activeTetrimino[t][0],n=activeTetrimino[t][1];(MATRIX[r][n+1]<0||void 0===MATRIX[r][n+1])&&(e=!1)}if(e){for(let e=0;e<activeTetrimino.length;e++)activeTetrimino[e][1]=activeTetrimino[e][1]+1;updateMatrix(),stopTest()}paused=!1},right2=()=>{let e=!0;for(let t=0;t<activeTetrimino2.length;t++){let r=activeTetrimino2[t][0],n=activeTetrimino2[t][1];(MATRIX2[r][n+1]<0||void 0===MATRIX2[r][n+1])&&(e=!1)}if(e){for(let e=0;e<activeTetrimino2.length;e++)activeTetrimino2[e][1]=activeTetrimino2[e][1]+1;updateMatrix2(),stopTest2()}},left=()=>{paused=!0;let e=!0;for(let t=0;t<activeTetrimino.length;t++){let r=activeTetrimino[t][0],n=activeTetrimino[t][1];(MATRIX[r][n-1]<0||void 0===MATRIX[r][n-1])&&(e=!1)}if(e){for(let e=0;e<activeTetrimino.length;e++)activeTetrimino[e][1]=activeTetrimino[e][1]-1;updateMatrix(),stopTest()}paused=!1},left2=()=>{paused2=!0;let e=!0;for(let t=0;t<activeTetrimino2.length;t++){let r=activeTetrimino2[t][0],n=activeTetrimino2[t][1];(MATRIX2[r][n-1]<0||void 0===MATRIX2[r][n-1])&&(e=!1)}if(e){for(let e=0;e<activeTetrimino2.length;e++)activeTetrimino2[e][1]=activeTetrimino2[e][1]-1;updateMatrix2(),stopTest2()}paused2=!1},dropPoints=1,drop=()=>{if(!pauseAll){if(paused=!0,!stopTest()&&!gameEnded){lowerTetrimino();const e=level;e>9&&(e=9),points1+=1*levelMultiplier[e],document.getElementById("points1").innerHTML=points1}paused=!1}},drop2=()=>{if(!pauseAll){if(paused2=!0,!stopTest2()&&!gameEnded2){lowerTetrimino2();const e=level;e>9&&(e=9),points2+=1*levelMultiplier[e],document.getElementById("points2").innerHTML=points2}paused2=!1}},LSPIN=[[[-1,-2],[-1,0],[0,-1],[0,-1]],[[0,0],[-1,1],[-2,2],[-1,-1]],[[0,1],[0,1],[1,0],[1,2]],[[1,1],[2,-2],[1,-1],[0,0]]],JSPIN=[[[-1,0],[-2,1],[-1,-1],[0,-2]],[[0,0],[0,0],[-1,2],[-1,2]],[[0,2],[1,1],[2,-1],[1,0]],[[1,-2],[1,-2],[0,0],[0,0]]],SSPIN=[[[-1,-1],[0,-2],[-1,1],[0,0]],[[1,1],[0,2],[1,-1],[0,0]]],ZSPIN=[[[-1,1],[0,-1],[-1,0],[0,-2]],[[1,-1],[0,1],[1,0],[0,2]]],OSPIN=[[[0,0],[0,0],[0,0],[0,0]]],TSPIN=[[[-1,1],[0,-1],[0,-1],[0,0]],[[0,0],[0,0],[0,0],[-1,1]],[[0,0],[0,1],[0,1],[1,-1]],[[1,-1],[0,0],[0,0],[0,0]]],ISPIN=[[[-1,1],[0,0],[1,-1],[2,-2]],[[1,-1],[0,0],[-1,1],[-2,2]],[[-1,2],[0,1],[1,0],[2,-1]],[[1,-2],[0,-1],[-1,0],[-2,1]]],SPINARR=[LSPIN,JSPIN,SSPIN,ZSPIN,OSPIN,TSPIN,ISPIN];let currentSpin=0,currentSpin2=0;const spin=()=>{if(paused=!0,!gameEnded){let e=[],t=SPINARR[activeColor-1][currentSpin];for(let r=0;r<t.length;r++){let n=activeTetrimino[r][0],i=activeTetrimino[r][1],a=t[r][0],o=t[r][1];e.push([n+a,i+o])}if(spinValidator(e))return paused=!1,!1;activeTetrimino=e,updateMatrix(),currentSpin===SPINARR[activeColor-1].length-1?currentSpin=0:currentSpin++}paused=!1},spinValidator=e=>{for(let t=0;t<e.length;t++){let r=e[t][0],n=e[t][1];if(r<0||n<0||MATRIX[r][n]<0||void 0===MATRIX[r][n])return!0}return!1},spin2=()=>{if(paused2=!0,!gameEnded2){let e=[],t=SPINARR[activeColor2-1][currentSpin2];for(let r=0;r<t.length;r++){let n=activeTetrimino2[r][0],i=activeTetrimino2[r][1],a=t[r][0],o=t[r][1];e.push([n+a,i+o])}if(spinValidator2(e))return paused2=!1,!1;activeTetrimino2=e,updateMatrix2(),currentSpin2===SPINARR[activeColor2-1].length-1?currentSpin2=0:currentSpin2++}paused2=!1},spinValidator2=e=>{for(let t=0;t<e.length;t++){let r=e[t][0],n=e[t][1];if(r<0||n<0||MATRIX2[r][n]<0||void 0===MATRIX2[r][n])return!0}return!1},moves={37:{pressed:!1,func:left,firstPress:!1},39:{pressed:!1,func:right,firstPress:!1},40:{pressed:!1,func:drop,firstPress:!1},65:{pressed:!1,func:left2,firstPress:!1},68:{pressed:!1,func:right2,firstPress:!1},83:{pressed:!1,func:drop2,firstPress:!1}};document.addEventListener("keydown",(e=>{moves[e.keyCode]&&(moves[e.keyCode].pressed=!0,!1===moves[e.keyCode].firstPress&&(moves[e.keyCode].func(),timeStart=performance.now(),moves[e.keyCode].firstPress=!0))})),document.addEventListener("keyup",(e=>{switch(moves[e.keyCode]&&(moves[e.keyCode].pressed=!1),moves[e.keyCode]&&(moves[e.keyCode].firstPress=!1),e.keyCode){case 38:spin();break;case 87:spin2();break;case 32:pauseFunc();break;case 80:playFunc();break;case 79:restartFunc();break;case 13:attack();break;case 81:attack2()}}));const executeFirstMove=()=>{Object.keys(moves).forEach((e=>{moves[e].firstPress&&moves[e].func()}))},executeMoves=()=>{Object.keys(moves).forEach((e=>{moves[e].pressed&&moves[e].func()}))},executeDrop=()=>{!0===moves[40].pressed&&moves[40].func(),!0===moves[83].pressed&&moves[83].func()};